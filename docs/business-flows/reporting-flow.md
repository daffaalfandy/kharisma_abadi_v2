# Reporting & Analytics Flow

**Status:** PARTIALLY IMPLEMENTED
**Coverage:** Income reports, limited analytics
**Missing:** Employee performance, service metrics, customer analysis
**Priority:** MEDIUM (enhancements to existing dashboard)

---

## Current Reports Available

### 1. Income Dashboard

**Endpoint:** `GET /api/dashboard/income/`

**Returns:**
```json\n{\n  \"today\": 2750000,\n  \"this_month\": 45000000,\n  \"this_year\": 500000000,\n  \"all_time\": 3200000000\n}\n```\n\n**Breakdown by Service:** (if available)\n- Car Wash Today: Rp 1,200,000\n- Laundry Today: Rp 800,000\n- Water Delivery Today: Rp 750,000\n\n### 2. Employee Income Reports\n\n**Endpoint:** `GET /api/employee-income/`\n\n**Returns:**\n- List of employees with today's earnings\n- List of employees with this month's earnings\n\n**Queries:**\n```sql\nSELECT \n    e.employee_id,\n    e.name,\n    SUM(ct.final_price * carwash_type.cut_amount / 100) / COUNT(DISTINCT ce.carwash_transaction_id) as today_income\nFROM employees e\nJOIN carwash_employees ce ON e.employee_id = ce.employee_id\nJOIN carwash_transactions ct ON ce.carwash_transaction_id = ct.carwash_transaction_id\nJOIN carwash_types carwash_type ON ct.carwash_type_id = carwash_type.carwash_type_id\nWHERE DATE(ct.date) = CURDATE()\nGROUP BY e.employee_id, e.name;\n```\n\n### 3. Chart Data (Year & Month Views)\n\n**Endpoint:** `POST /api/dashboard/chart/year/`\n\n**Request:**\n```json\n{\n  \"year\": 2025,\n  \"type\": 1  // 1=All, 2=Car Wash, 3=Laundry, 4=Carpet, 5=Water\n}\n```\n\n**Returns:**\n```json\n[\n  {\"month\": \"Jan\", \"total\": 40000000},\n  {\"month\": \"Feb\", \"total\": 45000000},\n  ...\n  {\"month\": \"Oct\", \"total\": 55000000}\n]\n```\n\n**Chart Types:**\n- Bar chart: Revenue by month\n- Line chart: Trend analysis\n- Pie chart: Service breakdown\n\n---\n\n## Proposed Additional Reports\n\n### 1. Employee Performance Report\n\n**Endpoint:** `GET /api/reports/employee-performance`\n\n**Query Parameters:**\n- start_date: YYYY-MM-DD\n- end_date: YYYY-MM-DD\n- sort_by: \"income\" | \"transactions\" | \"average_per_transaction\"\n\n**Returns:**\n```json\n[\n  {\n    \"employee_id\": 1,\n    \"name\": \"Ahmad\",\n    \"total_transactions\": 85,\n    \"total_income\": 1275000,\n    \"average_per_transaction\": 15000,\n    \"daily_average\": 38000,\n    \"days_worked\": 22\n  }\n]\n```\n\n**SQL:**\n```sql\nSELECT\n    e.employee_id,\n    e.name,\n    COUNT(DISTINCT ce.carwash_transaction_id) as total_transactions,\n    SUM(ct.final_price * ct_type.cut_amount / 100 / \n        (SELECT COUNT(*) FROM carwash_employees \n         WHERE carwash_transaction_id = ct.carwash_transaction_id)) as total_income,\n    AVG(ct.final_price * ct_type.cut_amount / 100 / \n        (SELECT COUNT(*) FROM carwash_employees \n         WHERE carwash_transaction_id = ct.carwash_transaction_id)) as avg_per_transaction,\n    COUNT(DISTINCT DATE(ct.date)) as days_worked\nFROM employees e\nJOIN carwash_employees ce ON e.employee_id = ce.employee_id\nJOIN carwash_transactions ct ON ce.carwash_transaction_id = ct.carwash_transaction_id\nJOIN carwash_types ct_type ON ct.carwash_type_id = ct_type.carwash_type_id\nWHERE ct.end_date IS NOT NULL\nAND ct.date BETWEEN :start_date AND :end_date\nGROUP BY e.employee_id, e.name\nORDER BY total_income DESC;\n```\n\n### 2. Service Quality Report\n\n**Data Needed (Not Currently Tracked):**\n- Service start time\n- Service end time\n- Quality rating (1-5 stars)\n- Customer satisfaction\n- Rework required (yes/no)\n- Refund/dispute (yes/no)\n\n**Proposed Query:**\n```\nFor each service:\n- Average duration\n- Rework rate (% requiring redo)\n- Customer satisfaction average\n- Refund rate\n- Peak times (when most transactions)\n- Slow times (when fewest transactions)\n```\n\n### 3. Customer Lifetime Value (Water Delivery)\n\n**Endpoint:** `GET /api/reports/customer-lifetime-value`\n\n**Returns:**\n```json\n[\n  {\n    \"customer_id\": 456,\n    \"name\": \"Budi Hartono\",\n    \"first_delivery\": \"2023-01-15\",\n    \"last_delivery\": \"2025-10-22\",\n    \"days_as_customer\": 1016,\n    \"total_deliveries\": 180,\n    \"total_spent\": 3600000,\n    \"average_per_delivery\": 20000,\n    \"average_per_month\": 71500,\n    \"status\": \"ACTIVE\",\n    \"churned_days\": null\n  }\n]\n```\n\n**SQL:**\n```sql\nSELECT\n    dc.drinking_water_customer_id,\n    dc.name,\n    MIN(dwt.date) as first_delivery,\n    MAX(dwt.date) as last_delivery,\n    DATEDIFF(CURDATE(), MIN(dwt.date)) as days_as_customer,\n    COUNT(DISTINCT dwt.drinking_water_transaction_id) as total_deliveries,\n    SUM(dwt.final_price) as total_spent,\n    AVG(dwt.final_price) as average_per_delivery,\n    CASE\n        WHEN DATEDIFF(CURDATE(), MAX(dwt.date)) > 30 THEN 'CHURNED'\n        ELSE 'ACTIVE'\n    END as status\nFROM drinking_water_customers dc\nJOIN drinking_water_transactions dwt ON dc.drinking_water_customer_id = dwt.drinking_water_customer_id\nGROUP BY dc.drinking_water_customer_id, dc.name\nORDER BY total_spent DESC;\n```\n\n### 4. Revenue Breakdown by Service\n\n**Endpoint:** `GET /api/reports/revenue-breakdown`\n\n**Returns:**\n```json\n{\n  \"period\": \"2025-10\",\n  \"total_revenue\": 45000000,\n  \"breakdown\": {\n    \"car_wash\": {\n      \"gross\": 18000000,\n      \"percentage\": 40,\n      \"transactions\": 350\n    },\n    \"laundry\": {\n      \"gross\": 12000000,\n      \"percentage\": 27,\n      \"transactions\": 80\n    },\n    \"carpet\": {\n      \"gross\": 8000000,\n      \"percentage\": 18,\n      \"transactions\": 15\n    },\n    \"water_delivery\": {\n      \"gross\": 7000000,\n      \"percentage\": 15,\n      \"transactions\": 350\n    }\n  }\n}\n```\n\n### 5. Cash Flow Report\n\n**Purpose:** Track cash in/out for reconciliation\n\n**Data:**\n- Opening balance\n- Daily transactions (grouped by payment method)\n- Closing balance\n- Variance (expected vs actual)\n\n**Endpoint:** `GET /api/reports/cash-flow`\n\n**Parameters:**\n- date: YYYY-MM-DD\n\n**Returns:**\n```json\n{\n  \"date\": \"2025-10-22\",\n  \"opening_balance\": 500000,\n  \"transactions\": [\n    {\"time\": \"08:15\", \"type\": \"carwash\", \"amount\": 50000, \"method\": \"CASH\"},\n    {\"time\": \"08:45\", \"type\": \"laundry\", \"amount\": 40000, \"method\": \"CASH\"},\n    {\"time\": \"09:30\", \"type\": \"expense\", \"amount\": -10000, \"method\": \"CASH\"},\n    ...\n  ],\n  \"total_cash_in\": 350000,\n  \"total_cash_out\": 10000,\n  \"expected_closing\": 840000,\n  \"actual_closing\": 840000,\n  \"variance\": 0,\n  \"balanced\": true\n}\n```\n\n### 6. Business Metrics Dashboard\n\n**Key Metrics to Track:**\n\n```\nðŸ“Š Daily Metrics\n- Transactions today: 45\n- Revenue today: Rp 2,750,000\n- Average transaction: Rp 61,111\n- Busy hours: 8-9 AM, 5-7 PM\n\nðŸ“ˆ Weekly Metrics\n- Transactions this week: 280\n- Revenue this week: Rp 17,500,000\n- Best day: Wednesday (Rp 3,200,000)\n- Worst day: Monday (Rp 2,100,000)\n- Growth vs last week: +5%\n\nðŸ“‰ Monthly Metrics\n- Transactions this month: 1,200\n- Revenue this month: Rp 72,000,000\n- Growth vs last month: +8%\n- Average daily: Rp 2,400,000\n- Forecast (if trend continues): Rp 75,600,000\n\nðŸ‘¥ Staff Metrics\n- Active employees: 12\n- Top earner: Ahmad (Rp 1,850,000 this month)\n- Busiest: Budi (85 transactions)\n- Average per employee: Rp 425,000\n\nðŸ’° Financial Metrics\n- Gross revenue: Rp 72,000,000\n- Employee cost (40% for laundry): Rp 8,500,000\n- Business income: Rp 63,500,000\n- Operating margin: 88%\n```\n\n---\n\n## Report Export Formats\n\n**Supported Formats:**\n- CSV (Excel compatible)\n- PDF (printable)\n- JSON (API friendly)\n- Excel (.xlsx) - Future\n- Charts (embedded PNG) - Future\n\n**Example CSV Export:**\n```\nDate,Service,Transactions,Revenue,Employee Cost,Business Income\n2025-10-01,Car Wash,52,2600000,780000,1820000\n2025-10-01,Laundry,12,450000,180000,270000\n2025-10-01,Water,45,900000,0,900000\n2025-10-01,Carpet,3,600000,240000,360000\n2025-10-01,TOTAL,112,4550000,1200000,3350000\n```\n\n---\n\n## Report Scheduling\n\n### Automated Report Generation\n\n**Daily Reports:**\n- End of day: Income summary (email to manager)\n- Timestamp: 5:30 PM daily\n- Recipients: Manager, Owner\n\n**Weekly Reports:**\n- Every Sunday: Weekly revenue summary\n- Include: YoY comparison, trends\n\n**Monthly Reports:**\n- 1st of month: Previous month summary\n- Include: Employee performance, service breakdown\n\n**Implementation:**\n- Cron job or scheduled task\n- Generate PDF/email\n- Archive reports\n\n---\n\n## Proposed Implementation\n\n### Phase 1: Enhance Current Dashboard\n- Improve existing income reports\n- Add service breakdown\n- Add employee income details\n\n### Phase 2: Add Performance Reports\n- Employee performance metrics\n- Service quality tracking\n- Time tracking for services\n\n### Phase 3: Add Analytics\n- Customer lifetime value\n- Revenue forecasting\n- Trend analysis\n\n### Phase 4: Advanced Features\n- Real-time dashboard\n- Custom report builder\n- Scheduled email reports\n\n---\n\n## Conclusion\n\nCurrent reporting is **LIMITED** - focuses only on income summaries. Missing:\n- Performance metrics\n- Service quality\n- Customer analytics\n- Cash flow tracking\n- Employee metrics\n\n---\n\n**Priority:** MEDIUM\n**Effort:** 2-3 weeks (Phase 1-2)\n**Related:** dashboard_controller.py\n