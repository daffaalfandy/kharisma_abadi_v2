# Exception Flows & Error Handling

---

## 1. Order Cancellation Flow

### Car Wash Cancellation

**Scenario:** Customer cancels car wash order before service starts

```mermaid
flowchart TD\n    Start([Customer Requests Cancellation]) --> CheckStatus{Service\\nStatus?}\n    CheckStatus -->|Not Started| AllowCancel[Approve cancellation]\n    CheckStatus -->|In Progress| AskContinue{Customer\\nStill Wants\\nRefund?}\n    CheckStatus -->|Completed| DenyCancel[Deny - service already completed]\n    \n    AskContinue -->|Yes| PartialRefund[Refund 50% for partial service]\n    AskContinue -->|No| Resume[Resume service]\n    \n    AllowCancel --> UpdateStatus[Set status = CANCELLED]\n    PartialRefund --> UpdateStatus\n    DenyCancel --> End1([Cancellation Denied])\n    Resume --> End2([Service Resumed])\n    \n    UpdateStatus --> ProcessRefund[Process refund to original payment method]\n    ProcessRefund --> UpdateIncome[Remove from income calculations]\n    UpdateIncome --> NotifyCustomer[Notify customer]\n    NotifyCustomer --> End3([Cancellation Complete])\n```

**Database Update:**
```sql\nUPDATE carwash_transactions\nSET status = 'CANCELLED',\n    end_date = NOW(),\n    cancelled_reason = 'Customer requested cancellation',\n    updated_at = NOW()\nWHERE carwash_transaction_id = 123;\n\nINSERT INTO payments (\n    transaction_type, transaction_id,\n    amount, payment_method, payment_status, notes\n) VALUES (\n    'carwash', 123,\n    -25000,  -- Negative for refund\n    'CASH',  -- Original method\n    'PAID',\n    'Cancellation refund - 50% service charge retained'\n);\n```

**Business Rules:**
- ✅ Before start: Full refund
- ⚠️ In progress: 50% refund (labor already incurred)\n- ❌ Completed: No refund (or per management discretion)\n- Employee compensation: Kept for work already done\n\n### Laundry Cancellation\n\n**Scenarios:**\n- Before processing starts: Full refund\n- After processing (washing): 30% refund (non-refundable labor)\n- Before pickup: Full refund\n- After pickup: No refund\n\n---\n\n## 2. Service Quality Issues\n\n### Poor Quality Resolution\n\n**Scenario:** Customer returns service claiming poor quality\n\n```mermaid\nflowchart TD\n    Start([Customer Reports Quality Issue]) --> Document[Staff documents issue:\\n- Photos\\n- Description\\n- Date/time]\n    \n    Document --> Assess{Issue\\nValid?}\n    \n    Assess -->|No| DenyRefund[Deny refund claim\\nService meets standards]\n    Assess -->|Yes| Severity{Severity?}\n    \n    Severity -->|Minor| Rework[Offer rework/touch-up]\n    Severity -->|Major| PartialRefund[Offer 50% refund]\n    Severity -->|Critical| FullRefund[Offer full refund]\n    \n    Rework --> ApprovalCheck{Customer\\nAccepts\\nRework?}\n    ApprovalCheck -->|Yes| PerformRework[Perform service again]\n    ApprovalCheck -->|No| PartialRefund2[Offer partial refund]\n    PartialRefund2 --> ProcessRefund\n    \n    PerformRework --> Satisfied{Satisfied\\nNow?}\n    Satisfied -->|Yes| ClosedResolved[Close - Resolved]\n    Satisfied -->|No| FullRefund\n    \n    PartialRefund --> ProcessRefund[Process 50% refund]\n    FullRefund --> ProcessRefund\n    DenyRefund --> ClosedDenied[Close - No refund]\n    \n    ProcessRefund --> UpdateIncome[Adjust income calculations]\n    UpdateIncome --> ClosedResolved\n```

**Business Rules:**
- Document everything (photos, notes, timestamps)\n- Minor issues: Rework or small discount\n- Major issues: Rework + discount or 50% refund\n- Critical issues: Full refund\n- Manager approval required for refunds > Rp 50,000\n\n**Dispute Resolution:**\n- 7-day window for complaints\n- All refunds documented\n- Customer satisfaction priority\n- Preserve customer relationship if possible\n\n---\n\n## 3. Payment Issues\n\n### Insufficient Funds (Cash on Delivery)\n\n**Scenario:** Customer cannot pay full amount at time of delivery\n\n```\nDelivery: Water 2 gallons = Rp 40,000\nCustomer has: Rp 30,000 (short Rp 10,000)\n\nOptions:\n1. Accept partial payment, create invoice for remainder\n   - Record: PARTIAL payment of Rp 30,000\n   - Status: UNPAID (Rp 10,000 outstanding)\n   - Due: End of week\n   \n2. Collect payment next delivery\n   - Skip delivery\n   - Reschedule\n   - Notify customer\n   \n3. Refuse delivery\n   - Return water to warehouse\n   - Mark transaction CANCELLED\n   - Follow up with customer\n```\n\n**Database:**\n```sql\nINSERT INTO payments (\n    transaction_type, transaction_id,\n    amount, payment_method, payment_status, paid_amount,\n    notes\n) VALUES (\n    'water', 789,\n    40000, 'CASH', 'PARTIAL', 30000,\n    'Customer short Rp 10,000, collect with next delivery'\n);\n```\n\n### Disputed Charge\n\n**Scenario:** Customer disputes amount charged\n\n```\nInvoice: Car wash Rp 75,000\nCustomer claims: Should be Rp 50,000 (basic wash, not premium)\n\nInvestigation:\n1. Check receipt/order\n2. Review service type selected\n3. Verify price correct for type\n4. If error: Issue refund\n5. If correct: Show receipt to customer\n\nResolution:\n- If overcharge: Refund difference + apologize\n- If correct: Explain and maintain relationship\n```\n\n---\n\n## 4. Operational Issues\n\n### Incorrect Service Delivered\n\n**Scenario:** Wrong service type delivered or incorrect quantity\n\n**Examples:**\n- Car wash: Charged for premium, received basic\n- Laundry: Customer paid for 10 items, received 9\n- Water: Ordered 2 gallons, delivered 1\n\n**Resolution Process:**\n```\n1. Identify error immediately\n2. Apologize and acknowledge\n3. Correct immediately if possible\n4. Document error for training\n5. Offer compensation (discount, free service)\n6. Update records to reflect actual service\n\nDatabase:\n- Update quantity to actual delivered\n- Adjust price to match\n- Create credit memo if customer paid too much\n```\n\n### System Downtime During Transaction\n\n**Scenario:** Power outage or system crash during order creation\n\n**Risk:** Transaction data lost or inconsistent\n\n**Mitigation:**\n1. Backup power (UPS) for 15-30 minutes\n2. Database transactions to ensure atomicity\n3. Manual paper backup system\n4. Reconciliation process after restore\n\n**Recovery:**\n```\nIf transaction lost:\n1. Recreate from paper receipt\n2. Match to payment records\n3. Audit for consistency\n4. Reconcile final balance\n\nIf transaction incomplete:\n1. Check if payment received\n2. If paid: Create transaction record\n3. If not paid: Customer retries order\n```\n\n---\n\n## 5. Inventory/Supply Issues\n\n### Out of Stock (Water Delivery)\n\n**Scenario:** Customer orders water but warehouse is empty\n\n**Current System:**\n- No inventory tracking\n- Risk of promising unavailable product\n\n**Proposed Solution:**\n```\n1. Check available stock before accepting order\n2. If out of stock:\n   - Offer alternative product\n   - Offer future delivery date\n   - Offer competitor alternative\n   \n3. Record order as PENDING (delivery date TBD)\n4. Notify customer when stock arrives\n5. Complete delivery when possible\n```\n\n### Equipment Failure (Service)\n\n**Scenario:** Washing machine breaks during car wash service\n\n**Resolution:**\n```\n1. Stop service immediately\n2. Notify customer of delay\n3. Offer alternatives:\n   - Reschedule service\n   - Refund full amount\n   - Use alternative equipment/location\n   \n4. Document downtime for maintenance tracking\n5. Prioritize fixing equipment\n```\n\n---\n\n## 6. Data Integrity Issues\n\n### Duplicate Transaction\n\n**Scenario:** Same order created twice (system or human error)\n\n**Detection:**\n```sql\n-- Find duplicate transactions\nSELECT \n    customer_id,\n    COUNT(*) as count\nFROM transactions\nWHERE DATE(created_at) = CURDATE()\nGROUP BY customer_id\nHAVING COUNT(*) > 1;\n```\n\n**Resolution:**\n1. Identify which is legitimate transaction\n2. Mark duplicate as CANCELLED\n3. Process refund for duplicate\n4. Audit income/employee payments\n5. Correct if already recorded\n\n### Missing or Incorrect Employee Assignment\n\n**Scenario:** Car wash transaction created without employee\n\n**Current System:**\n- Would cause division by zero error\n- Service cannot be credited\n\n**Handling:**\n```\n1. Transaction validation: Require at least 1 employee\n2. If missing during entry: Force selection\n3. If already missing in DB: Escalate for manual correction\n4. Retroactively assign employee\n5. Recalculate income distribution\n```\n\n---\n\n## 7. Security Issues\n\n### Suspected Fraud/Tampering\n\n**Scenarios:**\n- Employee modifying their own transactions for income\n- Deleting records to cover up mistakes\n- Altering final_price incorrectly\n\n**Current Risk:** HIGH (No authentication, no audit trail)\n\n**Proposed Solution:**\n```\n1. Authentication system (who did what)\n2. Audit trail (all changes logged with timestamp/user)\n3. Role-based access (employee can't modify their own income)\n4. Reconciliation (daily/weekly audit)\n5. Approval workflow (manager review before final)\n\nAudit Log Example:\n2025-10-22 14:30:15 | User: Ahmed | Action: CREATE\n2025-10-22 14:35:22 | User: Ahmed | Action: UPDATE (final_price: 50000 → 75000)\n2025-10-22 14:36:00 | User: Manager | Action: REVIEW (Approved)\n```\n\n---\n\n## 8. Customer Disputes\n\n### Escalation Procedure\n\n**Level 1: Cashier Resolution**\n- Customer refund < Rp 50,000\n- Simple issue (wrong amount, missing item)\n- Authority: Process refund immediately\n\n**Level 2: Manager Review**\n- Refund Rp 50,000 - Rp 500,000\n- Complex issue (quality dispute, service question)\n- Authority: Investigate, approve refund or deny\n- Timeframe: Within 24 hours\n\n**Level 3: Owner/Executive Decision**\n- Refund > Rp 500,000\n- Major dispute (system failure, multiple issues)\n- Relationship at risk\n- Authority: Final approval/denial\n- Timeframe: Within 48 hours\n- Follow-up: Direct contact with customer\n\n**Documentation:**\n- Keep detailed records of all disputes\n- Document resolution\n- Track patterns (quality, pricing, specific employees)\n- Use for continuous improvement\n\n---\n\n## Common Error Responses\n\n| Scenario | Current System | Recommended |\n|----------|--------|--------|\n| Service type not found | 404 error | \"Please select a valid service type\" |\n| No employees available | System crash | \"No staff available, please try later\" |\n| Invalid price | Crashes | \"Invalid price amount\" |\n| Duplicate transaction | May accept | \"Duplicate detected, confirm first\" |\n| Customer not found | Crashes | \"Customer not found, create new\" |\n| Payment failed | No handling | \"Payment declined, try another method\" |\n| Database error | Generic 500 | \"System error, contact admin\" |\n\n---\n\n## Conclusion\n\nCurrent system has **MINIMAL** error handling. No validation, no user-friendly messages, prone to crashes.\n\nRecommendation: Implement comprehensive error handling and recovery procedures in redesigned system.\n\n---\n\n**Priority:** HIGH\n**Related:** payment-processing-flow.md, authentication-flow.md\n