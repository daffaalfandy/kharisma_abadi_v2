# User Management Flow

**Status:** PARTIALLY IMPLEMENTED (Employee management exists, but no user authentication)
**Related to:** authentication-flow.md, employee_controller.py
**Priority:** MEDIUM (depends on authentication implementation)

---

## Overview

User management involves two separate systems in Kharisma Abadi:

1. **Employees** - Service staff who perform car washes, laundry, deliveries
2. **System Users** - (NOT YET IMPLEMENTED) Application login accounts with roles

This document covers the proposed User/Authentication system. Employee management is documented in car-wash-flow.md.

---

## Employee Management (Current - Partial)

### Employee Lifecycle

```mermaid
flowchart TD\n    Start([New Employee Joins]) --> Register[Cashier registers employee]\n    Register --> EnterInfo[Record:\\n- Full Name\\n- Phone Number]\n    \n    EnterInfo --> SaveEmployee[Save to employee table]\n    SaveEmployee --> AssignToJobs[Assign to service jobs]\n    AssignToJobs --> TrackIncome[Track earnings per transaction]\n    TrackIncome --> GenerateReport[Generate income reports]\n    \n    GenerateReport --> ContinueWork{Still\\nEmployed?}\n    ContinueWork -->|Yes| MoreJobs[Continue working on jobs]\n    MoreJobs --> ContinueWork\n    ContinueWork -->|No| Deactivate[Deactivate employee record]\n    Deactivate --> Archive[Archive earnings history]\n    Archive --> End([Employee Removed])\n```\n\n**Database Table:**\n```sql\nCREATE TABLE employees (\n  employee_id INT PRIMARY KEY AUTO_INCREMENT,\n  name VARCHAR(128) UNIQUE NOT NULL,\n  phone_number VARCHAR(18),\n  created_at DATETIME,\n  updated_at DATETIME\n);\n```\n\n**Current Features:**\n- ✅ CRUD operations (Create, Read, Update, Delete)\n- ✅ Income tracking per employee\n- ✅ Pagination and search\n- ✅ Date range filtering\n\n**Missing Features:**\n- ❌ No employment status (ACTIVE, INACTIVE, TERMINATED)\n- ❌ No hire/termination dates\n- ❌ No hourly rate or salary information\n- ❌ No employment contract\n- ❌ No schedule/availability\n- ❌ No performance tracking\n\n---\n\n## System User Management (Proposed)\n\n### User Roles\n\n**Role Hierarchy:**\n\n```\nADMIN (System Administrator)\n├── Full access to all functions\n├── Manage users and roles\n├── System configuration\n└── Access all reports\n\nMANAGER (Business Manager)\n├── View all reports\n├── Manage employees\n├── Create service types\n├── View financial reports\n└── Manage pricing\n\nCASHIER (Front Desk Staff)\n├── Create transactions\n├── Process payments\n├── View customer info\n├── Print receipts\n└── View limited reports\n\nVIEWER (Read-only Access)\n├── View reports\n├── View customer history\n└── No creation/modification\n```\n\n### User Lifecycle\n\n```mermaid\nflowchart TD\n    Start([New Employee Hired]) --> AdminCreate[Admin creates system account]\n    AdminCreate --> EnterCreds[Enter username, email, temporary password]\n    EnterCreds --> AssignRole[Assign role:\\nADMIN/MANAGER/CASHIER/VIEWER]\n    \n    AssignRole --> SendInvite[Send welcome email with\\nlogin link]\n    SendInvite --> FirstLogin[New user first login]\n    \n    FirstLogin --> ChangePassword[Forced password change]\n    ChangePassword --> SetupComplete[Account setup complete]\n    \n    SetupComplete --> WorkActive{User\\nStill\\nEmployed?}\n    WorkActive -->|Yes| DailyLogin[Daily login to application]\n    DailyLogin --> UseApp[Use application per role]\n    UseApp --> WorkActive\n    \n    WorkActive -->|No| Terminate[Termination initiated]\n    Terminate --> Deactivate[Admin deactivates account]\n    Deactivate --> DisableAccess[Disable login\\nArchive activity log]\n    DisableAccess --> End([User Deactivated])\n```\n\n---\n\n## User Creation (Admin Only)\n\n### New User Registration\n\n**Endpoint:** `POST /api/admin/users/`\n\n**Required Fields:**\n```json\n{\n  \"username\": \"ahmad_surya\",\n  \"email\": \"ahmad@kharisma.com\",\n  \"full_name\": \"Ahmad Suryanto\",\n  \"role\": \"CASHIER\",\n  \"phone\": \"08123456789\",\n  \"department\": \"Front Desk\"\n}\n```\n\n**Validation:**\n- Username: 3-20 chars, alphanumeric + underscore\n- Email: Valid email format, unique\n- Full name: Required\n- Role: Must be valid enum\n- Password: Auto-generated, sent via email\n\n**Password Requirements:**\n- Minimum 12 characters\n- Uppercase letter\n- Lowercase letter\n- Number\n- Special character\n- Not based on username\n\n**Database Operation:**\n```sql\nINSERT INTO users (\n    username, email, password_hash,\n    full_name, role, phone_number,\n    is_active, created_at, updated_at\n) VALUES (\n    'ahmad_surya',\n    'ahmad@kharisma.com',\n    bcrypt('Temp$Secure123!'),  -- Temporary password\n    'Ahmad Suryanto',\n    'CASHIER',\n    '08123456789',\n    TRUE,\n    NOW(),\n    NOW()\n);\n```\n\n**Notifications:**\n- Email sent: \"Your account has been created. Click to set password: [link]\"\n- SMS sent: \"Welcome to Kharisma Abadi. Set your password: [link]\"\n- Temporary password valid for 24 hours only\n\n---\n\n## Password Management\n\n### First Login - Change Password\n\n**Flow:**\n1. User clicks email/SMS link\n2. Page displays: \"Set Your New Password\"\n3. User enters new password (must meet requirements)\n4. System hashes and stores password\n5. Temporary password becomes invalid\n6. User redirected to login\n7. User logs in with new credentials\n\n**Validation:**\n- New password meets requirements\n- Confirm password matches\n- New password ≠ old password\n- Cannot reuse last 5 passwords\n\n### Password Reset\n\n**Forgotten Password Flow:**\n```\n1. User clicks \"Forgot Password\" on login page\n2. Enter email address\n3. System checks if email exists\n4. Email sent: \"Reset password link (valid 1 hour)\"\n5. User clicks link\n6. Page displays: \"Enter New Password\"\n7. User enters new password\n8. Password updated\n9. User logs in with new password\n```\n\n### Password Expiration\n\n**Current Recommendation:**\n- No expiration for initial implementation\n- Later: Require change every 90 days\n- Alert: \"Your password expires in 7 days\"\n\n---\n\n## User Activation/Deactivation\n\n### Deactivation (Employee Termination)\n\n**Endpoint:** `PUT /api/admin/users/{id}/deactivate`\n\n**Process:**\n```\n1. Manager informs admin of termination\n2. Admin logs termination date\n3. System deactivates account\n   - is_active = FALSE\n   - last_login unchanged (historical)\n   - password still hashed (recoverable if re-hired)\n   - created audit log entry\n4. Account no longer permits login\n5. History archived but not deleted\n```\n\n**Database Update:**\n```sql\nUPDATE users\nSET is_active = FALSE,\n    terminated_at = NOW(),\n    updated_at = NOW()\nWHERE user_id = 1;\n\nINSERT INTO audit_log (\n    user_id, action, details\n) VALUES (\n    1, 'DEACTIVATED',\n    'Employee terminated'\n);\n```\n\n### Reactivation (Rehire)\n\n```\n1. Manager indicates rehire\n2. Admin reactivates account\n3. User forced to change password\n4. Account reactivated with same username/email\n5. Employment history shows gap\n```\n\n---\n\n## Role-Based Permissions\n\n### Permission Matrix\n\n| Feature | ADMIN | MANAGER | CASHIER | VIEWER |\n|---------|-------|---------|---------|--------|\n| **Transactions** |\n| Create | ✅ | ✅ | ✅ | ❌ |\n| View | ✅ | ✅ | ✅ | ✅ |\n| Edit | ✅ | ✅ | ✅ | ❌ |\n| Delete | ✅ | ✅ | ❌ | ❌ |\n| **Reports** |\n| Dashboard | ✅ | ✅ | Limited | Limited |\n| Financial | ✅ | ✅ | ❌ | Limited |\n| Employee Income | ✅ | ✅ | ❌ | ❌ |\n| **Settings** |\n| Service Types | ✅ | ✅ | ❌ | ❌ |\n| Pricing | ✅ | ✅ | ❌ | ❌ |\n| Employees | ✅ | ✅ | Limited | ❌ |\n| **Administration** |\n| Manage Users | ✅ | ❌ | ❌ | ❌ |\n| Audit Logs | ✅ | Limited | ❌ | ❌ |\n| Backups | ✅ | ❌ | ❌ | ❌ |\n\n---\n\n## Activity Audit Trail\n\n### Audit Log Table\n\n```sql\nCREATE TABLE audit_log (\n  audit_id INT PRIMARY KEY AUTO_INCREMENT,\n  user_id INT NOT NULL,\n  action VARCHAR(50),  -- CREATE, UPDATE, DELETE, LOGIN, LOGOUT\n  entity_type VARCHAR(50),  -- carwash_transaction, employee, etc\n  entity_id INT,\n  old_values JSON,  -- Previous values for updates\n  new_values JSON,  -- New values\n  ip_address VARCHAR(45),\n  user_agent TEXT,\n  created_at DATETIME,\n  FOREIGN KEY (user_id) REFERENCES users(user_id),\n  INDEX idx_user_date (user_id, created_at),\n  INDEX idx_action (action),\n  INDEX idx_entity (entity_type, entity_id)\n);\n```\n\n### Audit Example\n\n```sql\nINSERT INTO audit_log (\n    user_id, action, entity_type, entity_id,\n    old_values, new_values, ip_address\n) VALUES (\n    5,\n    'UPDATE',\n    'carwash_transaction',\n    123,\n    '{\"final_price\": 50000}',\n    '{\"final_price\": 75000}',\n    '192.168.1.100'\n);\n```\n\n**Queries:**\n```sql\n-- Who modified this transaction?\nSELECT * FROM audit_log\nWHERE entity_type = 'carwash_transaction'\nAND entity_id = 123\nORDER BY created_at DESC;\n\n-- What did user 5 do today?\nSELECT * FROM audit_log\nWHERE user_id = 5\nAND DATE(created_at) = CURDATE()\nORDER BY created_at DESC;\n\n-- Suspicious activity - many deletes\nSELECT user_id, COUNT(*) as delete_count\nFROM audit_log\nWHERE action = 'DELETE'\nAND created_at > DATE_SUB(NOW(), INTERVAL 1 DAY)\nGROUP BY user_id\nHAVING delete_count > 10;\n```\n\n---\n\n## Session Management\n\n### Login Session\n\n```\nUser logs in → Token generated → Token valid for 1 hour\n\nAfter 1 hour:\n- Token expires\n- User gets 401 error on next request\n- Redirected to login page\n- Must log in again\n\nAlternative: Refresh token\n- Short-lived access token (1 hour)\n- Long-lived refresh token (7 days)\n- Refresh endpoint extends session\n- Improves UX, maintains security\n```\n\n### Concurrent Session Control\n\n```\nCurrent approach: Unlimited concurrent sessions\n- User can be logged in from multiple browsers/devices\n- No session tracking\n\nRecommended:\n- Allow 2-3 concurrent sessions per user\n- Log out other sessions when password changes\n- Log out all sessions when account deactivated\n- Show active sessions to user\n- Allow user to log out from other devices\n```\n\n---\n\n## Missing Features\n\n### Priority 1: Critical\n1. User authentication system\n2. Password hashing (bcrypt)\n3. Role-based access control\n4. Session management\n\n### Priority 2: Important\n5. Audit trail (who did what, when)\n6. Password reset functionality\n7. Account deactivation\n8. Multi-user support\n\n### Priority 3: Nice to Have\n9. Two-factor authentication (2FA)\n10. Single sign-on (SSO) integration\n11. User activity reports\n12. Permission customization per user\n13. Department/team management\n\n---\n\n## Implementation Roadmap\n\n**Phase 1 (Week 1):** User table and authentication\n**Phase 2 (Week 2):** Role-based access control\n**Phase 3 (Week 3):** Audit trail and monitoring\n**Phase 4 (Week 4):** Password management and session\n\n**Total Effort:** 3-4 weeks\n\n---\n\n## Conclusion\n\nEmployee management exists but System User management does not. Authentication is **CRITICAL** security gap requiring immediate implementation.\n\n---\n\n**Priority:** CRITICAL\n**Related:** authentication-flow.md, exception-flows.md\n**See Also:** employee_controller.py in codebase\n